â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           CATEGORY DATA CORRUPTION FIX - PRODUCTION DEPLOYMENT               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLEM:
  Videos had duplicate (typeId, typeName) pairs
  Example: typeId=#1 had BOTH "Asian" and "Unknown" in different videos
  UI showed duplicate category entries

ROOT CAUSE:
  Video scraper's upsert logic never updated typeId/typeName on rescrape
  Only fresh inserts set these fields, updates skipped them

SOLUTION (3 PARTS):
  âœ… 1. Code fix: Update upsert to refresh category fields
  âœ… 2. Database cleanup: Fix existing bad data
  âœ… 3. Add FK constraint: Prevent future corruption

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ FILES CREATED/MODIFIED:

  1. src/app/api/scraper/videos/route.ts (MODIFIED)
     - Lines 245-246: Added typeId and typeName to upsert update clause
     - Future scrapes will now refresh category information

  2. prisma/migrations/20241029_add_category_fk_and_fix_duplicates/migration.sql
     - Fix orphaned typeIds
     - Fix mismatched typeNames
     - Add foreign key constraint
     - Add index on (typeId, typeName)

  3. src/scripts/cleanup-category-duplicates.ts (NEW)
     - Analyze existing issues (dry-run mode)
     - Fix corrupted data
     - Verify FK constraint
     - Idempotent (safe to run multiple times)

  4. CATEGORY_CORRUPTION_FIX.md (DEPLOYMENT GUIDE)
     - Step-by-step deployment instructions
     - Verification queries
     - Rollback plan

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš¡ QUICK DEPLOYMENT:

  1. Review deployment guide:
     cat CATEGORY_CORRUPTION_FIX.md

  2. Backup database (CRITICAL!)
     # Your database backup tool here

  3. Analyze issues (no changes):
     npm run ts-node -- src/scripts/cleanup-category-duplicates.ts

  4. Fix issues:
     npm run ts-node -- src/scripts/cleanup-category-duplicates.ts --fix

  5. Apply migration:
     npm run migrate

  6. Verify:
     npm run ts-node -- src/scripts/cleanup-category-duplicates.ts

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”§ KEY CHANGES:

  BEFORE:
    update: {
      vodName: finalTitle,
      // âŒ typeId and typeName NOT updated
    }

  AFTER:
    update: {
      vodName: finalTitle,
      typeId: typeId,         // âœ… Now updates
      typeName: typeName,     // âœ… Now updates
    }

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… WHAT THIS FIXES:

  â€¢ Prevents duplicate (typeId, typeName) in future scrapes
  â€¢ Fixes existing bad data in database
  â€¢ Adds foreign key constraint for data integrity
  â€¢ Creates index for faster duplicate detection
  â€¢ Safe for production (backwards compatible)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â±ï¸  ESTIMATED TIME: 30 minutes

  â€¢ Code review: 5 min
  â€¢ Database backup: 5 min
  â€¢ Cleanup analysis: 2 min
  â€¢ Cleanup fix: 5 min
  â€¢ Migration: 2 min
  â€¢ Verification: 5 min

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸš¨ ROLLBACK:

  If issues occur:
    1. git revert 6e60d40
    2. npm run migrate:rollback
    3. Restore database backup if needed

  See CATEGORY_CORRUPTION_FIX.md for detailed rollback steps

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Commit: 6e60d40
Files changed: 4
Insertions: 647
Status: Ready for production deployment
