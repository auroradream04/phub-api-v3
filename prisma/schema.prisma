generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String       @id @default(cuid())
  email     String       @unique
  password  String
  name      String?
  role      String       @default("member")
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  accounts  Account[]
  ads       Ad[]
  sessions  Session[]
  embeds    VideoEmbed[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId], map: "Account_userId_fkey")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "Session_userId_fkey")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Ad {
  id           String         @id @default(cuid())
  title        String
  description  String?        @db.Text
  duration     Int
  status       String         @default("active")
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  userId       String
  forceDisplay Boolean        @default(false)
  weight       Int            @default(1)
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  impressions  AdImpression[]
  segments     AdSegment[]

  @@index([userId], map: "Ad_userId_fkey")
}

model AdSegment {
  id        String   @id @default(cuid())
  adId      String
  quality   Int
  filepath  String
  filesize  Int
  createdAt DateTime @default(now())
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@unique([adId, quality])
}

model AdImpression {
  id        String   @id @default(cuid())
  adId      String
  videoId   String
  timestamp DateTime @default(now())
  referrer  String?  @db.Text
  userAgent String?  @db.Text
  country   String?  @db.VarChar(2)
  ipAddress String?  @db.VarChar(45)
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@index([adId], map: "AdImpression_adId_fkey")
}

model SiteSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id        Int      @id
  name      String   @db.VarChar(100)
  isCustom  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isCustom])
}

model Video {
  id                    String    @id @default(cuid())
  vodId                 String    @unique
  vodName               String    @db.VarChar(255)
  typeId                Int
  typeName              String    @db.VarChar(100)
  vodEn                 String?   @db.VarChar(255)
  vodTime               DateTime  @default(now())
  vodRemarks            String?   @db.VarChar(100)
  vodPlayFrom           String    @default("YourAPI") @db.VarChar(100)
  vodPic                String?   @db.Text
  vodPicOriginal        String?   @db.Text
  vodArea               String?   @db.VarChar(100)
  vodLang               String?   @db.VarChar(50)
  vodYear               String?   @db.VarChar(10)
  vodActor              String?   @db.Text
  vodDirector           String?   @db.Text
  vodContent            String?   @db.Text
  vodPlayUrl            String    @db.Text
  views                 Int       @default(0)
  duration              Int?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  vodClass              String?   @db.VarChar(500)
  originalTitle         String?   @db.VarChar(255)
  vodProvider           String?   @db.VarChar(100)
  needsTranslation      Boolean   @default(false)
  translationFailedAt   DateTime?
  translationRetryCount Int       @default(0)

  @@index([typeId])
  @@index([vodTime])
  @@index([views])
  @@index([vodProvider])
  @@index([needsTranslation])
}

model DomainAccess {
  id          String          @id @default(cuid())
  domain      String          @unique @db.VarChar(255)
  status      String          @default("allowed")
  type        String          @default("whitelist")
  reason      String?         @db.Text
  addedBy     String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  requestLogs ApiRequestLog[]

  @@index([status])
  @@index([domain])
}

model ApiRequestLog {
  id                String        @id @default(cuid())
  domain            String?       @db.VarChar(255)
  domainAccessId    String?
  endpoint          String        @db.VarChar(500)
  method            String        @db.VarChar(10)
  statusCode        Int
  responseTime      Int?
  ipAddress         String?       @db.VarChar(45)
  userAgent         String?       @db.Text
  referer           String?       @db.Text
  country           String?       @db.VarChar(2)
  blocked           Boolean       @default(false)
  timestamp         DateTime      @default(now())
  clientFingerprint String?       @db.VarChar(16)
  hasReferrer       Boolean       @default(false)
  ipSessionHash     String?       @db.VarChar(16)
  domainAccess      DomainAccess? @relation(fields: [domainAccessId], references: [id])

  @@index([domain])
  @@index([endpoint])
  @@index([timestamp])
  @@index([blocked])
  @@index([domainAccessId])
  @@index([ipSessionHash])
  @@index([clientFingerprint])
}

model CacheLog {
  id        String   @id @default(cuid())
  action    String   @db.VarChar(50)
  target    String?  @db.VarChar(255)
  videoId   String?  @db.VarChar(255)
  success   Boolean  @default(true)
  reason    String?  @db.Text
  timestamp DateTime @default(now())

  @@index([action])
  @@index([target])
  @@index([timestamp])
  @@index([videoId])
}

model VideoEmbed {
  id                  String           @id @default(cuid())
  videoId             String
  title               String           @db.VarChar(255)
  redirectUrl         String           @db.Text
  enabled             Boolean          @default(true)
  createdBy           String
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  displayName         String?          @db.VarChar(255)
  previewDownloadedAt DateTime?
  previewExpiry       DateTime?
  previewM3u8Path     String?          @db.VarChar(500)
  previewSegmentDir   String?          @db.VarChar(500)
  previewSourceUrl    String?          @db.Text
  analytics           EmbedAnalytics[]
  user                User             @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([createdBy])
  @@index([createdAt])
}

model EmbedAnalytics {
  id             String     @id @default(cuid())
  embedId        String
  eventType      String     @db.VarChar(20)
  referrerDomain String?    @db.VarChar(255)
  userAgent      String?    @db.Text
  ipHash         String?    @db.VarChar(64)
  timestamp      DateTime   @default(now())
  embed          VideoEmbed @relation(fields: [embedId], references: [id], onDelete: Cascade)

  @@index([embedId])
  @@index([eventType])
  @@index([referrerDomain])
  @@index([timestamp])
}
